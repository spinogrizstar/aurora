# Алгоритмы по‑простому (без умных слов)

Этот файл объясняет, **как приложение считает пакет и сумму**, и где это менять.

## Что пользователь делает
1) Выбирает **сегмент** (Розница / Опт / Производитель). Можно несколько.
2) Дальше появляются блоки (ККТ, устройства, сценарии, поддержка, данные и т.д.).
3) Включает галочки и счётчики.

## Что хранится в `state`
В браузере есть объект `state` (см. `frontend/assets/state.js`). Это просто "коробка" с ответами пользователя.
Примеры:
- `state.segments` — список выбранных сегментов.
- `state.kkt` — список выбранных касс (может быть пустой).
- `state.device_scanner` и `state.device_tsd` — сколько сканеров и ТСД.
- `state.org_count` — сколько юрлиц.
- `state.support` — включена ли поддержка.

## Откуда берутся цены и правила
Всё лежит в одном месте: `frontend_shared/data/data.json`.

Внутри DATA есть 3 главные части:

### 1) `DATA.segments`
Это список пакетов для каждого сегмента.
Например:
- `DATA.segments["Розница"]` — пакеты для розницы.
- `DATA.segments["Опт"]` — пакеты для опта.

У пакета есть:
- `name` — название
- `price` — цена базы
- `inc` — что входит кратко
- `detail` — что входит подробно

### 2) `DATA.points_model`
Это "сколько баллов даёт каждая галочка".
Пример:
- `org_points_per_extra` — сколько баллов за каждое доп.юрлицо.
- `aggregation_points` — сколько баллов даёт агрегация.

### 3) `DATA.rub_per_point`
Сколько рублей стоит 1 балл сложности.

## Как считается сумма
Идея простая: **итог = база пакета + поддержка + услуги (баллы→рубли) + лицензии**.

### Шаг 1. Считаем баллы доп.услуг
Каждая опция даёт баллы. Эти баллы собираются в список "Услуги".

Примеры:
- Доп.кассы (кроме первой) → добавляют баллы.
- Доп.сканеры (кроме первого) → добавляют баллы.
- Доп.юрлица (кроме первого) → добавляют баллы.
- Агрегация / остатки / большие объёмы → добавляют баллы.

Потом:
`стоимость_услуг = баллы * DATA.rub_per_point`

### Шаг 2. Считаем лицензии (ПО)
Некоторые штуки считаются сразу в рублях, без баллов.
Сейчас это:
- ТСД → Клеверенс: `60 000 ₽ * количество ТСД`
- Если включена "коллективная работа": `25 000 ₽ * количество ТСД`

### Шаг 3. Выбираем пакет
Правило: **если сегментов несколько — берём самый дорогой пакет**.

То есть:
- выбираем подходящий пакет для каждого сегмента
- сравниваем их цены
- берём тот, у которого `price` максимальный

### Шаг 4. Складываем итог
`итого = цена_пакета + поддержка + услуги + лицензии`

## Где именно это считается в коде
### В браузере (UI)
- файлы:
  - `frontend_shared/data/data.json` — настройки (пакеты/цены/баллы)
  - `frontend/assets/state.js` — что выбрал пользователь
  - `frontend/assets/ui/checklist.js` — как рисуется чек‑лист
  - `frontend/assets/calc.js` — локальный расчёт (фолбэк)
  - `frontend/assets/update.js` — запрос к API и обновление правой панели

### В бэкенде (FastAPI)
- файл: `backend/v5/calc.py`
- там то же самое, но на Python.

Важно: бэкенд **читает DATA из JSON** (`backend/v5/data.py`), чтобы не рассинхронизироваться.

## Самые частые правки (куда лезть)
1) **Поменять цену пакета** → `DATA.segments[...][...].price`
2) **Поменять баллы у опции** → `DATA.points_model.<имя_поля>`
3) **Поменять "рублей за балл"** → `DATA.rub_per_point`
4) **Добавить новую галочку**:
   - добавить поле в `state`
   - добавить элемент UI (render)
   - добавить правило в расчёт (UI и backend)

Если хочешь совсем по‑тупому и пошагово, см. файл `docs/КАК_ПРАВИТЬ_БЕЗ_БОЛИ.md`.
