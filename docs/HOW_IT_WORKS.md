# Aurora Checklist — как всё работает

Этот файл объясняет проект «по‑тупому»: что где лежит и как считается итог.

## 1) Структура проекта

### Frontend (в браузере)
- `frontend/index.html` — страница.
- `frontend/assets/app.js` — точка входа (загрузка данных, рендер, первый расчёт).
- `frontend/assets/ui/checklist.js` — рисует чек‑лист (левая часть).
- `frontend/assets/ui/summary.js` — правая панель (пакет/состав/суммы).
- `frontend/assets/calc.js` — локальный расчёт (если бэкенд недоступен).
- `frontend/assets/update.js` — отправка state на API и обновление правой панели.
- `frontend_shared/data/data.json` — **все настройки цен/пакетов/баллов**.

### Backend (FastAPI)
- `backend/main.py` — приложение, раздаёт фронтенд и API.
- `backend/api_routes.py` — роуты:
  - `POST /api/v5/calculate` — расчёт
  - `POST /api/v5/docx` — генерация Word
  - `/admin` + `/api/admin/*` — админка
- `backend/v5/calc.py` — расчёт на Python (истина для Word).
- `backend/v5/docx_gen.py` — сборка .docx по шаблону.

---

## 2) Главная идея расчёта

**Итог = база пакета + услуги (баллы→рубли) + лицензии + поддержка.**

1) **Сегмент(ы)** задают «ветку» (Розница/Опт/Производитель).
2) По «баллам сложности» выбирается пакет внутри сегмента.
3) Дополнительные факторы (доп.юрлица, доп.устройства и т.п.) добавляют баллы.
4) Баллы конвертируются в рубли через коэффициент `rub_per_point`.
5) Отдельно считаются лицензии (например, Клеверенс) — сразу в рублях.

---

## 3) Где менять цены и тексты

### 3.1 Пакеты и их состав
Файл: `frontend_shared/data/data.json`

`segments -> <Сегмент> -> [пакеты]`.
У пакета важные поля:
- `name` — название
- `price` — база
- `inc` — кратко
- `detail` — детально (это попадает в Word и в правую панель)

### 3.2 Рубли за балл
Файл: `frontend_shared/data/data.json`
- поле: `rub_per_point`

### 3.3 Сколько баллов даёт каждая опция
Файл: `frontend_shared/data/data.json`
- объект: `points_model`

---

## 4) Админка (редактирование из браузера)

URL: `/admin`

Защита:
1) Нужно установить переменную окружения `AURORA_ADMIN_TOKEN`.
2) По умолчанию вход только с localhost. Для доступа из локалки:
   - `AURORA_ADMIN_ALLOW_LAN=1`

После сохранения админка пишет diff в: `logs/data_changes.log`.

---

## 5) Что делать, если «всё сломалось»

1) Открой `http://127.0.0.1:8000/data/data.json` — должен открыться JSON.
2) Нажми F12 → Console и пришли первую красную ошибку.
3) Если после правки админки не грузится — откати изменения по `logs/data_changes.log`.

---

## 6) Что хранится в `state` (данные формы)

Файл: `frontend/assets/state.js`.

Коротко по ключевым полям:
- `segments` — выбранные сегменты (можно несколько).
- `onec` — выбор конфигурации 1С + флаг «актуальная/неактуальная» (уходит в Word).
- `kkt` — список выбранных ККТ (для розницы).
- `device_scanner`, `device_tsd`, `tsd_collective` — устройства и коллективная работа.
- `org_count`, `multi_orgs` — количество юрлиц.
- `has_edo`, `needs_rr`, `needs_rework`, `needs_aggregation`, `big_volume`, `producer_codes`, `custom_integration` — сценарии/сложность.
- `support` — поддержка.
- `contacts` — реквизиты/контакт/цель (для протокола и ЛТ).
